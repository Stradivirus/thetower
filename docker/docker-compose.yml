services:
  # --- 1. Backend Service (FastAPI) ---
  backend:
    build:
      context: ../
      dockerfile: docker/backend.Dockerfile
    container_name: thetower_backend
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_SERVER: ${POSTGRES_SERVER}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_PORT: 5432
      SECRET_KEY: ${SECRET_KEY}
      ALGORITHM: ${ALGORITHM}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}

  # --- 2. Frontend Service (React Build + Caddy Server) ---
  frontend:
    build:
      context: ../
      dockerfile: docker/frontend.Dockerfile
    container_name: thetower_frontend
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    # Caddy 데이터 및 설정 볼륨 마운트 추가
    volumes:
      # Caddyfile 경로를 그대로 유지 (설정 파일)
      - ./Caddyfile:/etc/caddy/Caddyfile
      # Let's Encrypt 인증서 및 데이터 영구 저장
      - caddy_data:/data/caddy
      # Caddy 설정 파일 영구 저장 (선택 사항이지만 권장)
      - caddy_config:/config/caddy

# 볼륨 정의 추가
volumes:
  caddy_data: # Caddy의 인증서, 키, 기타 상태 정보 저장
  caddy_config: # Caddy의 자동 저장 설정 파일 저장 (autosave.json)